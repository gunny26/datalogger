<html>
<head>
    <link rel="stylesheet" href="jquery-ui.css" />
    <link rel="stylesheet" href="datalogger.css" />
    <!--jquery itself-->
    <script type="text/javascript" src="jquery-2.1.3.js"></script>
    <!-- used for autofill feature -->
    <script text="text/javascript" src="jquery-ui.js"></script>
    <!-- 
    <script src="jquery-ui.js"></script>
    <link rel="stylesheet" href="jquery-ui.css" />
    -->
    <!--highcharts graphics engine-->
    <script type="text/javascript" src="highcharts.js"></script>
    <script type="text/javascript" src="exporting.js"></script>
    <script type="text/javascript" src="datalogger_graphs.js"></script>
    <script type="text/javascript" src="datalogger_commons.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=0.9">
</head>
<body>
<script>
// base url for datalogger JSOn calls
var base_url = "/DataLogger";
// actual container reference to draw to
var actual_container_num = 0;
var actual_container;

$(document).ready(function(){
    // set some meaningful default values
    var datestring = get_url_key("datestring");
    $("#datestring").val(datestring);
    // add first graphics container
    add_container();
    // fill project and tablenames
    get_projects();
    // datatype select box
    var datatype = $("#datatype");
    datatype.append("<option value=absolute>absolute</option>");
    datatype.append("<option value=derive>derive</option>");
    datatype.append("<option value=per_s>per_s</option>");
    $("#addContainer").click(function() {
        alert("about to add new container");
        add_container();
    });
    $("#getData").click(function() {
        console.log("Selected value_key : " + JSON.stringify($("#select" ).val()));
        $("#container").val("fetching data from webservice, this could last for up to 2 minutes");
        getData();
    });
});

function ticker(message) {
    $('#status').html(message);
}

function get_url_key(keyname) {
    console.log("searching for " + keyname + " in url search parameters");
    var searchkeys = $(location).attr('search').slice(1).split("&")
    var retval;
    searchkeys.forEach(function (data) {
        console.log(data);
        var key = data.split("=")[0];
        if (keyname  == key) {
            var value = data.split("=")[1];
            console.log("found searched value : " + value);
            retval = value;
        }
    });
    return(retval);
}
 
/*
get a list of available projects
*/
function get_projects() {
    var url = base_url + '/get_projects/'
    console.log('Getting Data from url ' + url);
    ticker('getting list of projects');
    $("#select_project").empty();
    $('#select_project').append('<select id="project"></select>');
    $('#project').append('<option value=""></option>')
    $.getJSON(url).then(function(data) {
        $('body').css('cursor','wait');
        data.sort();
        data.forEach(function(rowdata) {
            console.log('appending '+rowdata+' to project select');
            $('#project').append('<option value=' + rowdata + '>' + rowdata + '</option>');
        });
        $('body').css('cursor','default');
    });
    // defining change for project
    $( '#project').change(function() {
        get_tablenames($('#project').val());
    });
}

/*
get a list of available tablenames for this project
project is required
*/
function get_tablenames(project) {
    $('#select_tablename').empty();
    $('#select_tablename').append('<select id="tablename"></select>');
    $('#tablename').append('<option value=""></option>');
    var url = base_url + '/get_tablenames/' + project
    ticker('getting list of tablenames for project ' + project);
    console.log('Getting Data from url ' + url);
    var ret_data = [];
    $.getJSON(url).then(function(data) {
        $('body').css('cursor','wait');
        data.sort();
        data.forEach( function(rowdata) {
            $('#tablename').append('<option value=' + rowdata + '>' + rowdata + '</option>');
            ret_data.push(rowdata);
        });
        $('body').css('cursor','default');
    });
    // definig chanhe for tablename
    $( '#tablename').change(function() {
        get_index_keynames($('#project').val(), $('#tablename').val());
        get_value_keynames($('#project').val(), $('#tablename').val());
        //recreate autocomplete for new data
        ticker('recreating autocomplete list for ' + $('#project').val() + "/" + $('#tablename').val());
        $('#keys').removeData('autocomplete');
        $('#keys').autocomplete({source: get_ts_caches($('#project').val(), $('#tablename').val(), $('#datestring').val()),});
    });
}

// get index keys for this particular project, tablename combination
function get_index_keynames(project, tablename) {
    $('#select_index_keynames').empty();
    $('#select_index_keynames').append('<select id="index_keynames"></select>');
    $('#index_keynames').append('<option value=""></option>');
    var url = base_url + "/get_index_keynames/" + project + "/" + tablename;
    console.log("getting index_keys from " + url);
    $.getJSON(url, function(result) {
        result.sort();
        result.forEach(function(item) {
            $('#index_keynames').append('<option value=' + item + '>' + item + '</option>');
            console.log("got index key: " + item);
        });
    });
}
 
/*
// get value keys for this particular project, tablename combination
*/
function get_value_keynames(project, tablename) {
    //var value_keynames = $("#value_keynames");
    $('#select_value_keynames').empty();
    $('#select_value_keynames').append('<select id="value_keynames" multiple size=10></select)')
    var url = base_url + "/get_value_keynames/" + project + "/" + tablename;
    console.log("getting value_keys from " + url);
    $.getJSON(url, function(result) {
        result.sort(); // sort value_keys
        result.forEach(function(item) {
            $('#value_keynames').append('<option value=' + item + '>' + item + '</option>');
            //console.log("got value key: " + item);
        });
    });
}

/*
get keys of caches timeseries for this project/tablename/datestring combination
*/
function get_ts_caches(project, tablename, datestring) {
    var url = base_url + "/get_ts_caches/" + project + "/" + tablename + "/" + datestring;
    console.log("Getting Data from url " + url);
    var keys = [];
    $.getJSON(url).then(function(data) {
        data.forEach( function(rowdata) {
            //console.log(rowdata);
            if (rowdata[2] == null) {
                keys.push(JSON.stringify(rowdata[1]));
            }
        });
    });
    return keys;
}


/*
Add new drawing container ad end of graphs container
*/
function add_container() {
    actual_container = "container" + actual_container_num;
    $("#graphs").append('<div id='+ actual_container + ' style="min-width: 310px; height: 400px; margin: 0 auto" align=center>' + (actual_container + 1) +'</div>');
    actual_container_num++;
    ticker("added new graphics container, actual container=" + actual_container);
}

/*
get data from json and create a graph on actual container
*/
function getData() {
    var project = $("#project").val();
    var tablename = $("#tablename").val();
    var datestring = $("#datestring").val();
    var keys = $("#keys").val();
    var selected = $("#value_keynames" ).val();
    var datatype = $("#datatype").val();
    var index_keynames = $("#index_keynames").val()
    if (index_keynames == "") {
        index_keynames = null;
    }
    var yAxisMax = $('#yAxisMax').val()
    if (yAxisMax == "") {
        yAxisMax = null;
    }
    var url = base_url + "/get_chart_data_ungrouped/" + project + "/" + tablename + "/" + datestring + "/" + Base64.encode(keys) + "/" + JSON.stringify(selected) + "/" + JSON.stringify(datatype) + "/" + JSON.stringify(index_keynames);
    console.log("Getting Data from url " + url);
    ticker("Fetching data, this could last for some time, if this is the first request");
    $.getJSON(url).then(function(data) {
        $('#stats').html(data.stats);
        console.log(data.stats);
        console.log("Drawing to actual_container = #" + actual_container);
        title = "Datum :"+datestring+"<br>, Project:"+project+", Tablename: "+tablename+"<br>, key:" + keys + ", values:" + JSON.stringify(selected);
        draw_develop(actual_container, title, data.data, yAxisMax);
        ticker("Got data, finished, maybe you select another one?");
    });
}

</script>
<h1>Datalogger Graphics Engine</h1>
<table>
    <tr>
        <td>
            <h2>Mandatory Parameters</h2>
            <table>
                <tr>
                    <td>
                        <label title="Datestring in form YYYY-MM-DD">Date</label>
                        <div><input id="datestring" type="text" size=10></div>
                    </td><td>
                        <label>Project</label>
                        <div id="select_project"></div>
                    </td><td>
                        <label>Tablename</label>
                        <div id="select_tablename">select one project first</div>
                    </td>
                </tr>
            </table>
            <h2>Search Parameters</h2>
            <table>
                <tr>
                    <td>
                        <label>Key(s)</label>
                        <div><input id="keys" type=text value="" size=60></div>
                    </td>
                </tr>
            </table>
            <h2>Filter Parameters</h2>
            <table>
                <tr>
                    <td>
                        <label title="at least one must be selected">Values</label>
                        <div id="select_value_keynames">select project and tablename first</div>
                    </td><td>
                        <label title="select one field to group by this field">Grouping Indexes</label>
                        <div id="select_index_keynames">selecz project and tablename first</div>
                    </td><td>
                        <label title="depends on kind of value_key, absolut : draw as is, counter : use per_s or derive">Datatype</label>
                        <div><select id="datatype"></select></div>
                    </td><td>
                        <label title="max value of yAxis, if nothing is given autoscale">y-Max</label>
                        <div><input id="yAxisMax" type=text size=5></div>
                    </td></tr>
            </table>
        </td><td>
            <div id="stats">There will be some statistics when data is fetched</div>
        </td>
    </tr>
</table>
<div id="status"></div>
<button id="getData" type="button">Fetch Data</button>
<button id="addContainer" type="button">Add new Container</button>
<div id="graphs">
</div>
</body>
</html>

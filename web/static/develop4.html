<html>
<head>
<!--jquery itself-->
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
<script type="text/javascript" src="jquery-2.1.3.js"></script>
<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
<!--highcharts graphics engine-->
<script src="http://code.highcharts.com/highcharts.js"></script>
<script src="http://code.highcharts.com/modules/exporting.js"></script>
<script src="datalogger_graphs.js"></script>
</head>
<body>
<script>
$(document).ready(function(){
    // set some meaningful default values
    // get_projects();
    var url = "http://srvmghomer.tilak.cc/datalogger/RawData/get_projects/"
    console.log("Getting Data from url " + url);
    $('body').css('cursor','wait');
    $.getJSON(url).then(function(data) {
        data.forEach(function(rowdata) {
            console.log("appending "+rowdata+" to project select");
            $("#project").append("<option value=" + rowdata + ">" + rowdata + "</option>");
        });
    });
    $('body').css('cursor','default');
    /*
    // try to get better values from search fields given to this page
    */
    console.log("getting search parameter to prefill the form fields");
    var searchkeys = $(location).attr('search').slice(1).split("&")
    searchkeys.forEach(function (data) {
        console.log(data);
        var key = data.split("=")[0];
        var value = data.split("=")[1];
        var newvalue;
        if (key == "keys") {
            console.log("keys found, is array : " + value.split(",")[0]);
            newvalue = JSON.stringify(value.split(","));
        } else {
            newvalue = value;
        }
        console.log("Key  : " + key);
        console.log("Value: " + newvalue);
        /* preselect project value */
        if (key == "project") {
            console.log("setting project default value to "+value);
            $("#project option[value=" + value + "]").attr("selected", "selected");
        } else {
            $("#" + key).val(newvalue);
        }
    });
    console.log("search parameter:" + searchkeys);
    /*
    get data for autofill search box
    */
    $("#keys").autocomplete({source: get_keys(),});
    /*
    get value keys for this particular project, tablename combination
    */
    var value_keynames = $("#value_keynames");
    var url = "http://srvmghomer.tilak.cc/datalogger/RawData/get_value_keynames/" + $("#project").val() + "/" + $("#tablename").val();
    console.log("getting value_keys from " + url);
    $.getJSON(url, function(result) {
        result.sort(); // sort value_keys
        result.forEach(function(item) {
            value_keynames.append('<option value=' + item + '>' + item + '</option>');
            console.log("got value key: " + item);
        });
    });
    // get index keys for this particular project, tablename combination
    var index_keynames = $("#index_keynames");
    var url = "http://srvmghomer.tilak.cc/datalogger/RawData/get_index_keynames/" + $("#project").val() + "/" + $("#tablename").val();
    console.log("getting index_keys from " + url);
    $.getJSON(url, function(result) {
        result.forEach(function(item) {
            index_keynames.append('<option value=' + item + '>' + item + '</option>');
            console.log("got index key: " + item);
        });
    });
    // datatype select box
    var datatype = $("#datatype");
    datatype.append("<option value=absolute>absolute</option>");
    datatype.append("<option value=derive>derive</option>");
    datatype.append("<option value=per_s>per_s</option>");
    $("#clickme").click(function() {
        alert("handler for .click() called,keyids=" + $("#keyids").val());
    });
    $("#getData").click(function() {
        console.log("Selected value_key : " + JSON.stringify($("#select" ).val()));
        $("#container").val("fetching data from webservice, this could last for up to 2 minutes");
        getData();
    });
});

function get_projects() {
    var url = "http://srvmghomer.tilak.cc/datalogger/RawData/get_projects/"
    console.log("Getting Data from url " + url);
    $('body').css('cursor','wait');
    $.getJSON(url).then(function(data) {
        data.forEach(function(rowdata) {
            console.log("appending "+rowdata+" to project select");
            $("#project").append("<option value=" + rowdata + ">" + rowdata + "</option>");
        });
    });
    $('body').css('cursor','default');
    get_tablenames();
}

function get_tablenames() {
    var project = $("#project").val();
    var url = "http://srvmghomer.tilak.cc/datalogger/RawData/get_tablenames/" + project
    console.log("Getting Data from url " + url);
    $('body').css('cursor','wait');
    var ret_data = [];
    $.getJSON(url).then(function(data) {
        data.forEach( function(rowdata) {
            $("#tablename").append("<option value=" + rowdata + ">" + rowdata + "</option>");
            ret_data.push(rowdata);
        });
    });
    $('body').css('cursor','default');
}

function get_keys() {
    var project = $("#project").val();
    var tablename = $("#tablename").val();
    var datestring = $("#datestring").val();
    var url = "http://srvmghomer.tilak.cc/datalogger/RawData/get_keys/" + project + "/" + tablename + "/" + datestring
    var series;
    console.log("Getting Data from url " + url);
    $('body').css('cursor','wait');
    var keys = [];
    $.getJSON(url).then(function(data) {
        data.forEach( function(rowdata) {
            //console.log(rowdata);
            keys.push(JSON.stringify(rowdata));
        });
    });
    $('body').css('cursor','default');
    return keys;
}

function getData() {
    var project = $("#project").val();
    var tablename = $("#tablename").val();
    var datestring = $("#datestring").val();
    var keys = $("#keys").val();
    var selected = $("#value_keynames" ).val();
    var datatype = $("#datatype").val();
    var index_keynames = $("#index_keynames").val()
    var url = "http://srvmghomer.tilak.cc/datalogger/RawData/get_chart_data_ungrouped/" + project + "/" + tablename + "/" + datestring + "/" + keys + "/" + JSON.stringify(selected) + "/" + JSON.stringify(datatype) + "/" + JSON.stringify(index_keynames)
    var series;
    console.log("Getting Data from url " + url);
    $('body').css('cursor','wait');
    //document.body.style.cursor = "wait";
    $.getJSON(url).then(function(data) {
        console.log(data);
        draw_develop("#container", keys, JSON.stringify(selected), data);
    });
    $('body').css('cursor','default');
    //document.body.style.cursor = "default";
}

</script>
<h1>Datalogger Graphics Engine</h1>
<table>
<tr><td>project</td><td><select id="project"></select></td></tr>
<tr><td>tablename</td><td><select id="tablename"></select></td></tr>
<tr><td>datestring</td><td><div><input id="datestring" type="text" size=60></div></td></tr>
<tr><td>keys</td><td><div><input id="keys" type=text value="" size=60></div></td></tr>
<tr><td>value_keynames</td><td><select id="value_keynames" multiple size=10></select></td></tr>
<tr><td>index_keynames</td><td><select id="index_keynames">
    <option selected disabled value=''></option>
</select></td></tr>
<tr><td>datatype</td><td><select id="datatype"></select></td></tr>
</table>
<button id="getData" type="button">Fetch Data</button> 
<div id="container" style="min-width: 310px; height: 400px; margin: 0 auto">There will be data after you clicked fetch</div>
</body>
</html>

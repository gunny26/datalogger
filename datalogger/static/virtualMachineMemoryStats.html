<html>
<head>
<!--jquery itself-->
<script type="text/javascript" src="jquery-2.1.3.js"></script>
<!--highcharts graphics engine-->
<script src="http://code.highcharts.com/highcharts.js"></script>
<script src="http://code.highcharts.com/modules/exporting.js"></script>
</head>
<body>
<script>
$(document).ready(function(){
    // set some meaningful default values
    $("#project").val("vicenter");
    $("#tablename").val("virtualMachineMemoryStats");
    $("#servername").val("srvpralki1.tilak.cc");
    $("#datestring").val("2015-05-31")
    var searchkeys = $(location).attr('search').slice(1).split("&")
    searchkeys.forEach(function (data) {
        console.log(data);
        var key = data.split("=")[0];
        var value = data.split("=")[1];
        console.log("Key  : " + key);
        console.log("Value: " + value);
        $("#" + key).val(value);
    });
    console.log("search parameter:" + searchkeys);
    $("#clickme").click(function() {
        alert("hadler for .click() called,keyids=" + $("#keyids").val());
    });
    $("#getData").click(function() {
        getData();
    });
});

function draw_memory(hostname, active, consumed, granted, overhead, shared, swapped) {
    $('#container').highcharts({
        chart: {
            type: 'spline'
        },
        title: {
            text: 'Memory Consumption of ' + hostname
        },
        subtitle: {
            text: 'memory used in kb'
        },
        xAxis: {
            type: 'datetime',
            dateTimeLabelFormats: { // don't display the dummy year
                month: '%e. %b',
                year: '%b'
            },
            title: {
                text: 'Date'
            }
        },
        yAxis: {
            title: {
                text: 'kb'
            },
            min: 0
        },
        tooltip: {
            headerFormat: '<b>{series.name}</b><br>',
            pointFormat: '{point.x:%e. %b}: {point.y:.2f} m'
        },

        plotOptions: {
            spline: {
                marker: {
                    enabled: false
                }
            }
        },

        series: [{
            name: 'active',
            data: active,
        },
        {
            name: 'consumed',
            data: consumed,
        },
        {
            name: 'granted',
            data: granted,
        },
        {
            name: 'overhead',
            data: overhead,
        },
        {
            name: 'shared',
            data: shared,
        },
        {
            name: 'swapped',
            data: swapped,
        },
       ]
    });
}

function getData() {
    var project = $("#project").val();
    var tablename = $("#tablename").val();
    var datestring = $("#datestring").val();
    var servername = $("#servername").val();
    var instance = "None"
    var url = "http://srvmghomer.tilak.cc/datalogger/RawData/getVicenterTimeseries/" + tablename + "/" + datestring + "/" + servername + "/" +instance;
    var active = [];
    var consumed = [];
    var granted = [];
    var overhead = [];
    var shared = [];
    var swapped = [];
    console.log("Getting Data from url " + url);
    $.getJSON(url).then(function(data) {
        document.body.style.cursor = "wait";
        // data is already javascript not json
        // use only item 3 in array, and convert to int
        data.forEach(function(row) {
            var ts = new Date((parseInt(row[0]) + 7200) * 1000); //has to be new and multiplied by 1000
            active.push([ts, parseInt(row[1])]);
            consumed.push([ts, parseInt(row[2])]);
            granted.push([ts, parseInt(row[3])]);
            overhead.push([ts, parseInt(row[4])]);
            shared.push([ts, parseInt(row[5])]);
            swapped.push([ts, parseInt(row[6])]);
        })
        draw_memory(servername, active, consumed, granted, overhead, shared, swapped);
        document.body.style.cursor = "default";
    });
}

</script>
<h1>Memory Statistics</h1>
<div>Project    : <input id="project" type=text value="vicenter"></div>
<div>Tablename  : <input id="tablename" type=text value=""></div>
<div>Servername : <input id="servername" type=text value=""></div>
<div>Datestring : <input id="datestring" type="text"></div>
<div id="getData">click here to fetch data</div>
<div id="container" style="min-width: 310px; height: 400px; margin: 0 auto">There will be data after you clicked fetch</div>
</body>
</html>
